# Output [Sample3.jpg](/agents-architecture-to-cloudformation/data/samples/sample3.jpg)

![sample3.jpg](/agents-architecture-to-cloudformation/data/samples/sample3.jpg)

The process of uploading the aforementioned diagram generates an incomplete set of step-by-step instructions. Enhance the step-by-step explanation by replacing it with the following text:

```
Architecture contains the following components:
1. Agents for Amazon Bedrock
2. AWS Lambda function
3. Amazon S3 Bucket
4. Amazon SNS

Here's a step-by-step explanation of the components and their interactions:

1. Agents for Amazon Bedrock: Agent consists of a single action group defined by an OpenAPI schema and integrates with an AWS Lambda function. 

2. AWS Lambda Bot Actions: This is an AWS Lambda function that acts as the central processing unit for the agents. It receives notifications from Agents and is used to perform actions. 

3. Amazon Simple Storage Service (Amazon S3): Amazon S3 is used to store Lambda code and OpenAPI schema for agents. 

4. Amazon SNS (Simple Notification Service): This is a pub/sub messaging service used for sending notifications within the system. The AWS Lambda Bot Actions function can send notifications to Amazon SNS.
```

Invoking the agent results in the following out and Knowledge Base retrievals. 

![artifact-1.png](/agents-architecture-to-cloudformation/data/samples/outputs/sample3/artifact-1.png)

> [!IMPORTANT]  
> The AWS CloudFormation template generated by the web application serves as a reference or starting point for development purposes. It should not be directly utilized in production environments without proper testing and validation. Developers are responsible for thoroughly evaluating and modifying the CloudFormation template to ensure compliance with established security best practices and guidelines before deploying it to production systems.

```
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  This template sets up an Amazon Bedrock agent with an AWS Lambda function for
  actions, an Amazon S3 bucket for storing artifacts, and an Amazon SNS topic
  for notifications. This template is not production ready and should only be
  used for inspiration.

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentName
      - Label:
          default: 'Artifacts'
        Parameters:
          - S3BucketWithArtifacts
          - OpenAPISchemaPrefix
          - LambdaCodePrefix
          - LambdaPythonFileName
      - Label:
          default: 'Agent Configuration'
        Parameters:
          - AgentName
          - AgentDescription
          - AgentInstruction
          - BedrockModelId
          - AgentAliasName
          - ActionGroupName
      - Label:
          default: 'Notification Configuration'
        Parameters:
          - EmailAddress

Parameters:
  EnvironmentName:
    Description: Unique name to distinguish different environments
    Type: String
    Default: test
    MinLength: 1
    MaxLength: 4

  S3BucketWithArtifacts:
    Type: String
    Description: S3 bucket with OpenAPI schema and Lambda function code
    MinLength: 1
    Default: my-artifacts-bucket

  OpenAPISchemaPrefix:
    Type: String
    Description: S3 Prefix for OpenAPI schema file
    Default: agent/schema.json
    MinLength: 1

  LambdaCodePrefix:
    Type: String
    Description: S3 Prefix for Lambda Code file
    Default: agent/lambda.zip
    MinLength: 1

  LambdaPythonFileName:
    Description: Lambda function handler name
    Type: String
    Default: index.lambda_handler
    MinLength: 1

  AgentName:
    Description: Agent name
    Type: String
    Default: MyAgent
    MinLength: 1

  AgentDescription:
    Type: String
    Default: My Bedrock Agent
    Description: Description for the Bedrock Agent
    MinLength: 1

  AgentInstruction:
    Type: String
    Default: You are a helpful assistant
    Description: Instruction for the Bedrock Agent
    MinLength: 1

  BedrockModelId:
    Type: String
    Default: anthropic.claude-3-sonnet-20240229-v1:0
    Description: Amazon Bedrock Model ID for the agent
    MinLength: 1

  AgentAliasName:
    Description: Agent Alias name
    Type: String
    MinLength: 1
    Default: MyAgentAlias

  ActionGroupName:
    Description: Action Group name
    Type: String
    Default: MyActionGroup
    MinLength: 1

  EmailAddress:
    Type: String
    Description: Email address to receive notifications
    AllowedPattern: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$

Resources:
  AgentResource:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Ref AgentName
      AgentResourceRoleArn: !GetAtt AgentRole.Arn
      FoundationModel: !Ref BedrockModelId
      Instruction: !Ref AgentInstruction
      Description: !Ref AgentDescription
      ActionGroups:
        - ActionGroupName: !Ref ActionGroupName
          ActionGroupExecutor:
            Lambda: !GetAtt AgentLambdaFunction.Arn
          ApiSchema:
            S3:
              S3BucketName: !Ref S3BucketWithArtifacts
              S3ObjectKey: !Ref OpenAPISchemaPrefix

  AgentAliasResource:
    Type: AWS::Bedrock::AgentAlias
    Properties:
      AgentId: !GetAtt AgentResource.AgentId
      AgentAliasName: !Ref AgentAliasName

  AgentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub AmazonBedrockExecutionRoleForAgents_${EnvironmentName}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - bedrock.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: BedrockInvokeModel
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelId}
        - PolicyName: S3Access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub arn:aws:s3:::${S3BucketWithArtifacts}/${OpenAPISchemaPrefix}

  AgentLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      FunctionName: !Sub agent-action-${EnvironmentName}
      Handler: !Ref LambdaPythonFileName
      Role: !GetAtt AgentLambdaRole.Arn
      Timeout: 300
      Code:
        S3Bucket: !Ref S3BucketWithArtifacts
        S3Key: !Ref LambdaCodePrefix

  AgentLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SNSPublishPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'sns:Publish'
                Resource: !Ref SNSTopic

  AgentLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt AgentLambdaFunction.Arn
      Principal: bedrock.amazonaws.com

  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref EmailAddress
          Protocol: email

Outputs:
  AgentId:
    Description: ID of the Bedrock Agent
    Value: !GetAtt AgentResource.AgentId

  AgentAliasName:
    Description: Name of the Bedrock Agent Alias
    Value: !Ref AgentAliasName

  LambdaFunctionArn:
    Description: ARN of the Lambda function
    Value: !GetAtt AgentLambdaFunction.Arn

  SNSTopicArn:
    Description: ARN of the SNS topic for notifications
    Value: !Ref SNSTopic
```